import os
import json
from datetime import datetime
from pathlib import Path

def write_hola_mundo_file():
    """Tool para escribir archivo 'Hola mundo' con timestamp actual"""
    
    try:
        # Obtener timestamp actual
        now = datetime.now()
        timestamp_str = now.strftime('%Y-%m-%d %H:%M:%S')
        filename_timestamp = now.strftime('%Y-%m-%d_%H-%M-%S')
        
        # ConfiguraciÃ³n de rutas
        base_path = Path("/home/node/.n8n/research-reports")
        
        # Crear directorio si no existe
        base_path.mkdir(parents=True, exist_ok=True)
        
        # Generar nombre de archivo con timestamp
        filename = f"hola_mundo_{filename_timestamp}.txt"
        file_path = base_path / filename
        
        # Crear contenido del archivo
        content = f"""Hola mundo!

Fecha y hora de creaciÃ³n: {timestamp_str}
Generado por: Test Tool Agent - Hola Mundo Writer
UbicaciÃ³n: {file_path}
Testing: âœ… Archivo creado exitosamente

---
Este es un archivo de prueba generado automÃ¡ticamente.
Contenido: Saludo "Hola mundo" con timestamp actual.
PropÃ³sito: Verificar funcionamiento del sistema de archivos.

Detalles tÃ©cnicos:
- Directorio base: {base_path}
- Archivo: {filename}
- Timestamp: {timestamp_str}
- Usuario: node (UID 1000)
- Permisos: 644 (rw-r--r--)

Â¡Hola mundo desde n8n local! ğŸŒ"""
        
        # Escribir archivo
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(content)
        
        # Verificar que se escribiÃ³ correctamente
        if not file_path.exists():
            raise IOError("El archivo no se creÃ³ correctamente")
        
        # Obtener informaciÃ³n del archivo
        file_stats = file_path.stat()
        file_size = file_stats.st_size
        file_size_kb = round(file_size / 1024, 2)
        
        # Resultado exitoso como STRING para toolCode
        success_message = f"""âœ… Archivo 'Hola mundo' creado exitosamente!

ğŸ“ UbicaciÃ³n: {file_path}
ğŸ“ Nombre: {filename}
ğŸ“Š TamaÃ±o: {file_size_kb} KB
ğŸ• Creado: {timestamp_str}

ğŸ“‹ Contenido del archivo:
"Hola mundo!
Fecha: {timestamp_str}"

ğŸ” Verificar archivo con:
docker exec n8n-local cat {file_path}
docker exec n8n-local ls -la {base_path}

âœ… Estado: Archivo verificado como existente"""
        
        # Log de Ã©xito (para debugging)
        print(f"âœ… HOLA MUNDO SUCCESS: {filename} ({file_size_kb} KB)")
        print(f"ğŸ“ LOCATION: {file_path}")
        
        return success_message
        
    except PermissionError as e:
        error_message = f"""âŒ Error de permisos al escribir archivo

ğŸš« Sin permisos para escribir en: {base_path if 'base_path' in locals() else '/home/node/.n8n/research-reports'}
âš ï¸ Error: {str(e)}
ğŸ”§ SoluciÃ³n: Verificar permisos del volumen n8n_data
ğŸ• Timestamp: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"""
        print(f"âŒ PERMISSION ERROR: {str(e)}")
        return error_message
        
    except IOError as e:
        error_message = f"""âŒ Error de E/S al escribir archivo

ğŸ’¾ Error de entrada/salida: {str(e)}
ğŸ”§ SoluciÃ³n: Verificar espacio en disco y configuraciÃ³n
ğŸ• Timestamp: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"""
        print(f"âŒ IO ERROR: {str(e)}")
        return error_message
        
    except Exception as e:
        error_message = f"""âŒ Error inesperado

ğŸ”´ Error general: {str(e)}
ğŸ”§ SoluciÃ³n: Revisar logs de n8n para mÃ¡s detalles
ğŸ• Timestamp: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"""
        print(f"âŒ GENERAL ERROR: {str(e)}")
        return error_message

# Ejecutar la funciÃ³n y retornar usando return explÃ­cito
result_message = write_hola_mundo_file()
return result_message